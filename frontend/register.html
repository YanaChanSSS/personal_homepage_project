<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册</title>
    <link rel="stylesheet" href="/frontend/css/shared.css" />
    <link rel="stylesheet" href="/frontend/css/register.css" />
</head>
<body>
    <div class="form-container">
        <div class="form-content">
            <h1 class="form-title">注册</h1>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerUsername" class="form-label">用户名</label>
                    <input type="text" id="registerUsername" name="username" required placeholder="建议使用英文或数字" class="form-input">
                    <div id="username-feedback" class="feedback"></div>
                </div>
                <div class="form-group">
                    <label for="registerEmail" class="form-label">邮箱</label>
                    <input type="email" id="registerEmail" name="email" required placeholder="请输入邮箱地址" class="form-input">
                    <div id="email-feedback" class="feedback"></div>
                </div>
                <div class="form-group captcha-group">
                    <label for="emailCode" class="form-label">邮箱验证码</label>
                    <div class="captcha-controls">
                        <input type="text" id="emailCode" name="emailCode" required placeholder="请输入邮箱验证码" class="form-input">
                        <button type="button" id="sendEmailCode" class="form-button">发送验证码</button>
                    </div>
                    <div id="email-code-feedback" class="feedback"></div>
                </div>
                <div class="form-group">
                    <label for="registerPassword" class="form-label">密码</label>
                    <input type="password" id="registerPassword" name="password" required placeholder="至少8位，包含大小写字母、数字和特殊字符" class="form-input">
                    <!-- 添加密码强度提示 -->
                    <div class="password-strength">
                        <div class="strength-meter">
                            <div class="strength-fill"></div>
                        </div>
                        <div class="strength-text">密码强度: <span id="strength-text">请输入密码</span></div>
                    </div>
                    <div class="password-requirements">
                        <p>密码要求:</p>
                        <ul>
                            <li id="req-length">至少8位字符</li>
                            <li id="req-uppercase">包含大写字母</li>
                            <li id="req-lowercase">包含小写字母</li>
                            <li id="req-number">包含数字</li>
                            <li id="req-special">包含特殊字符</li>
                        </ul>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword" class="form-label">确认密码</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="请再次输入密码" class="form-input">
                    <div id="password-match"></div>
                </div>
                <button type="submit" class="form-button">注册</button>
            </form>
        </div>
    </div>
    <div id="message" class="message"></div>
    <script src="/frontend/js/validator.js"></script>
    <script src="/frontend/js/api.js"></script>
    <script src="/frontend/js/events.js"></script>
    <script type="module">
        import { fetchPost } from '/frontend/js/utils.js';

        // 显示消息函数
        function showMessage(elementId, text, type) {
            const messageEl = document.getElementById(elementId);
            if (messageEl) {
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                messageEl.style.display = 'block';
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 3000);
            }
        }

        // 发送邮箱验证码
        document.getElementById('sendEmailCode').addEventListener('click', async function() {
            const email = document.getElementById('registerEmail').value;
            const button = this;
            
            if (!email) {
                showMessage('message', '请输入邮箱地址', 'error');
                return;
            }

            // 简单的邮箱格式验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('message', '请输入有效的邮箱地址', 'error');
                return;
            }

            // 检查是否在冷却时间内
            if (button.disabled) {
                return;
            }

            try {
                // 禁用按钮并开始倒计时
                button.disabled = true;
                let countdown = 60;
                const originalText = button.textContent;
                button.textContent = `${countdown}秒后重试`;

                const countdownInterval = setInterval(() => {
                    countdown--;
                    button.textContent = `${countdown}秒后重试`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }, 1000);

                // 发送邮箱验证码请求
                const data = await fetchPost('/send_email_code', {email: email});
                
                if (data.success) {
                    // 改为弹出提示
                    alert('验证码已发送，请查收邮箱');
                } else {
                    // 如果发送失败，重置按钮状态
                    clearInterval(countdownInterval);
                    button.disabled = false;
                    button.textContent = originalText;
                    showMessage('message', data.message || '发送失败', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('message', error.message || '网络错误，请稍后重试', 'error');
            }
        });

        // 密码强度检查
        function checkPasswordStrength(password) {
            const strengthMeter = document.querySelector('.strength-fill');
            const strengthText = document.getElementById('strength-text');
            
            if (!password) {
                strengthMeter.style.width = '0%';
                strengthText.textContent = '请输入密码';
                strengthText.className = '';
                return;
            }
            
            // 检查各项要求
            const lengthCheck = password.length >= 8;
            const uppercaseCheck = /[A-Z]/.test(password);
            const lowercaseCheck = /[a-z]/.test(password);
            const numberCheck = /\d/.test(password);
            const specialCheck = /[!@#$%^&*(),.?\":{}|<>]/.test(password);
            
            // 更新要求显示
            document.getElementById('req-length').className = lengthCheck ? 'valid' : 'invalid';
            document.getElementById('req-uppercase').className = uppercaseCheck ? 'valid' : 'invalid';
            document.getElementById('req-lowercase').className = lowercaseCheck ? 'valid' : 'invalid';
            document.getElementById('req-number').className = numberCheck ? 'valid' : 'invalid';
            document.getElementById('req-special').className = specialCheck ? 'valid' : 'invalid';
            
            // 计算强度
            const passedChecks = [lengthCheck, uppercaseCheck, lowercaseCheck, numberCheck, specialCheck]
                .filter(Boolean).length;
            
            // 更新强度条
            strengthMeter.style.width = (passedChecks * 20) + '%';
            
            // 设置颜色
            let color = '#e53e3e'; // 弱
            if (passedChecks >= 4) color = '#38a169'; // 强
            else if (passedChecks >= 3) color = '#dd6b20'; // 中等
            
            strengthMeter.style.backgroundColor = color;
            
            // 更新文本
            let text = '弱';
            let className = 'weak';
            
            if (passedChecks >= 4) {
                text = '强';
                className = 'strong';
            } else if (passedChecks >= 3) {
                text = '中等';
                className = 'medium';
            }
            
            strengthText.textContent = text;
            strengthText.className = className;
        }

        // 检查密码是否匹配
        function checkPasswordMatch() {
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchEl = document.getElementById('password-match');
            
            if (!confirmPassword) {
                matchEl.textContent = '';
                matchEl.className = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchEl.textContent = '密码匹配';
                matchEl.className = 'feedback success';
            } else {
                matchEl.textContent = '密码不匹配';
                matchEl.className = 'feedback error';
            }
        }

        // 添加密码强度检查
        document.getElementById('registerPassword').addEventListener('input', function() {
            const password = this.value;
            checkPasswordStrength(password);
            checkPasswordMatch();
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordMatch();
        });

        // 用户名实时验证
        document.getElementById('registerUsername').addEventListener('blur', async function() {
            const username = this.value;
            const feedback = document.getElementById('username-feedback');
            
            if (username.length < 3) {
                feedback.textContent = '用户名至少需要3个字符';
                feedback.className = 'feedback error';
                return;
            }
            
            if (username.length > 20) {
                feedback.textContent = '用户名不能超过20个字符';
                feedback.className = 'feedback error';
                return;
            }
            
            try {
                // 检查用户名是否已存在
                const data = await fetchPost('/check_username', {username: username});
                
                if (data.exists) {
                    feedback.textContent = '用户名已存在，请选择其他用户名';
                    feedback.className = 'feedback error';
                } else {
                    feedback.textContent = '用户名可用';
                    feedback.className = 'feedback success';
                }
            } catch (error) {
                console.error('Error:', error);
                feedback.textContent = '检查用户名时出错，请稍后再试';
                feedback.className = 'feedback error';
            }
        });

        // 邮箱实时验证
        document.getElementById('registerEmail').addEventListener('blur', async function() {
            const email = this.value;
            const feedback = document.getElementById('email-feedback');
            
            // 邮箱格式验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                feedback.textContent = '请输入有效的邮箱地址';
                feedback.className = 'feedback error';
                return;
            }
            
            try {
                // 检查邮箱是否已存在
                const data = await fetchPost('/check_email', {email: email});
                
                if (data.exists) {
                    feedback.textContent = '该邮箱已被注册，请使用其他邮箱';
                    feedback.className = 'feedback error';
                } else {
                    feedback.textContent = '邮箱地址可用';
                    feedback.className = 'feedback success';
                }
            } catch (error) {
                console.error('Error:', error);
                feedback.textContent = '检查邮箱时出错，请稍后再试';
                feedback.className = 'feedback error';
            }
        });

        // 验证密码
        function validatePassword(password) {
            if (password.length < 8) {
                return "密码长度至少8位";
            }
            
            if (!/[A-Z]/.test(password)) {
                return "密码必须包含至少一个大写字母";
            }
            
            if (!/[a-z]/.test(password)) {
                return "密码必须包含至少一个小写字母";
            }
            
            if (!/\d/.test(password)) {
                return "密码必须包含至少一个数字";
            }
            
            if (!/[!@#$%^&*(),.?\":{}|<>]/.test(password)) {
                return "密码必须包含至少一个特殊字符";
            }
            
            return null;
        }

        // 表单提交
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const emailCode = document.getElementById('emailCode').value;
            
            if (!username || !email || !password || !confirmPassword || !emailCode) {
                showMessage('message', '请填写所有字段', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('message', '两次输入的密码不一致', 'error');
                return;
            }
            
            // 检查密码强度
            const passwordError = validatePassword(password);
            if (passwordError) {
                showMessage('message', passwordError, 'error');
                return;
            }

            try {
                // 准备表单数据
                const formData = new FormData();
                formData.append('username', username);
                formData.append('email', email);
                formData.append('password', password);
                formData.append('confirmPassword', confirmPassword);
                formData.append('emailCode', emailCode);
                
                // 向后端发送注册请求
                const data = await fetchPost('/register', formData);
                
                if (data.success) {
                    showMessage('message', '注册成功！即将跳转到登录页...', 'success');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    showMessage('message', data.message || '注册失败', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('message', error.message || '网络错误，请稍后重试', 'error');
            }
        });
    </script>
</body>
</html>