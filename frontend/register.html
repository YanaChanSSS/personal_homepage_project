<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册</title>
    <link rel="stylesheet" href="css/register.css" />
</head>
<body>
    <div class="container">
        <h1>注册</h1>
        <form id="registerForm">
            <div class="form-group">
                <label for="registerUsername">用户名</label>
                <input type="text" id="registerUsername" name="username" required placeholder="建议使用英文或数字">
            </div>
            <div class="form-group">
                <label for="registerEmail">邮箱</label>
                <input type="email" id="registerEmail" name="email" required placeholder="请输入邮箱地址">
            </div>
            <div class="form-group captcha-group">
                <label for="emailCode">邮箱验证码</label>
                <div class="captcha-controls">
                    <input type="text" id="emailCode" name="emailCode" required placeholder="请输入邮箱验证码">
                    <button type="button" id="sendEmailCode">发送验证码</button>
                </div>
            </div>
            <div class="form-group">
                <label for="registerPassword">密码</label>
                <input type="password" id="registerPassword" name="password" required placeholder="至少8位，包含大小写字母、数字和特殊字符">
                <!-- 添加密码强度提示 -->
                <div class="password-strength">
                    <div class="strength-meter">
                        <div class="strength-fill"></div>
                    </div>
                    <div class="strength-text">密码强度: <span id="strength-text">请输入密码</span></div>
                </div>
                <div class="password-requirements">
                    <p>密码要求:</p>
                    <ul>
                        <li id="req-length">至少8位字符</li>
                        <li id="req-uppercase">包含大写字母</li>
                        <li id="req-lowercase">包含小写字母</li>
                        <li id="req-number">包含数字</li>
                        <li id="req-special">包含特殊字符</li>
                    </ul>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">确认密码</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="请再次输入密码">
                <div id="password-match"></div>
            </div>
            <button type="submit">注册</button>
        </form>
        <div class="switch-form">
            <p>已有账号？<a href="login.html">立即登录</a></p>
        </div>
        <div id="message" class="message" style="display: none;"></div>
    </div>

    <script>
        // 页面加载时获取图形验证码
        window.addEventListener('load', function() {
            refreshCaptcha();
        });

        // 刷新图形验证码
        function refreshCaptcha() {
            fetch('/captcha')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('captchaImage').src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40"><rect width="100" height="40" fill="#f0f0f0"/><text x="50%" y="50%" font-size="20" text-anchor="middle" fill="#333" dy=".3em">' + data.captcha + '</text></svg>';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 点击图片刷新验证码
        document.getElementById('captchaImage').addEventListener('click', refreshCaptcha);

        // 发送邮箱验证码
        document.getElementById('sendEmailCode').addEventListener('click', function() {
            const email = document.getElementById('registerEmail').value;
            
            if (!email) {
                showMessage('请输入邮箱地址', 'error');
                return;
            }

            // 简单的邮箱格式验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('请输入有效的邮箱地址', 'error');
                return;
            }

            // 发送邮箱验证码请求
            fetch('/send_email_code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({email: email})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('验证码已发送，请查收邮箱', 'success');
                    // 实际应用中应该添加倒计时功能
                } else {
                    showMessage(data.message || '发送失败', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请稍后重试', 'error');
            });
        });

        // 添加密码强度检查
        document.getElementById('registerPassword').addEventListener('input', function() {
            const password = this.value;
            checkPasswordStrength(password);
            checkPasswordMatch();
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordMatch();
        });

        function checkPasswordStrength(password) {
            const strengthMeter = document.querySelector('.strength-fill');
            const strengthText = document.getElementById('strength-text');
            const lengthReq = document.getElementById('req-length');
            const uppercaseReq = document.getElementById('req-uppercase');
            const lowercaseReq = document.getElementById('req-lowercase');
            const numberReq = document.getElementById('req-number');
            const specialReq = document.getElementById('req-special');

            let strength = 0;
            let feedback = '';

            // 检查各项要求
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            // 与后端保持一致的特殊字符检查
            const hasSpecial = /[!@#$%^&*(),.?\":{}|<>]/.test(password);

            // 更新要求显示状态
            updateRequirement(lengthReq, hasLength);
            updateRequirement(uppercaseReq, hasUppercase);
            updateRequirement(lowercaseReq, hasLowercase);
            updateRequirement(numberReq, hasNumber);
            updateRequirement(specialReq, hasSpecial);

            // 计算强度
            if (hasLength) strength++;
            if (hasUppercase) strength++;
            if (hasLowercase) strength++;
            if (hasNumber) strength++;
            if (hasSpecial) strength++;

            // 设置强度条和文本
            strengthMeter.style.width = (strength * 20) + '%';
            
            if (password.length === 0) {
                strengthText.textContent = '请输入密码';
                strengthText.className = '';
                strengthMeter.className = 'strength-fill';
            } else if (strength < 3) {
                strengthText.textContent = '弱';
                strengthText.className = 'weak';
                strengthMeter.className = 'strength-fill weak';
            } else if (strength < 5) {
                strengthText.textContent = '中等';
                strengthText.className = 'medium';
                strengthMeter.className = 'strength-fill medium';
            } else {
                strengthText.textContent = '强';
                strengthText.className = 'strong';
                strengthMeter.className = 'strength-fill strong';
            }
        }

        function updateRequirement(element, isValid) {
            if (isValid) {
                element.classList.add('valid');
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
            }
        }

        function checkPasswordMatch() {
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('password-match');

            if (confirmPassword.length === 0) {
                matchElement.textContent = '';
                return;
            }

            if (password === confirmPassword) {
                matchElement.textContent = '密码匹配';
                matchElement.className = 'match-success';
            } else {
                matchElement.textContent = '密码不匹配';
                matchElement.className = 'match-error';
            }
        }

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const captcha = document.getElementById('captcha').value;
            const emailCode = document.getElementById('emailCode').value;
            
            if (!username || !email || !password || !confirmPassword || !captcha || !emailCode) {
                showMessage('请填写所有字段', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('两次输入的密码不一致', 'error');
                return;
            }
            
            // 检查密码强度
            const passwordError = validatePassword(password);
            if (passwordError) {
                showMessage(passwordError, 'error');
                return;
            }

            // 向后端发送注册请求
            fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&confirmPassword=${encodeURIComponent(confirmPassword)}&captcha=${encodeURIComponent(captcha)}&emailCode=${encodeURIComponent(emailCode)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('注册成功！即将跳转到登录页...', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showMessage(data.message || '注册失败', 'error');
                    // 如果是验证码错误，刷新图形验证码
                    if (data.message.includes('验证码')) {
                        refreshCaptcha();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请稍后重试', 'error');
            });
        });

        function validatePassword(password) {
            if (password.length < 8) {
                return "密码长度至少8位";
            }
            
            if (!/[A-Z]/.test(password)) {
                return "密码必须包含至少一个大写字母";
            }
            
            if (!/[a-z]/.test(password)) {
                return "密码必须包含至少一个小写字母";
            }
            
            // 修改此处以匹配后端验证逻辑
            if (!/\d/.test(password)) {
                return "密码必须包含至少一个数字";
            }
            
            // 与后端保持一致的特殊字符检查
            if (!/[!@#$%^&*(),.?\":{}|<>]/.test(password)) {
                return "密码必须包含至少一个特殊字符(!@#$%^&*(),.?\":{}|<>)";
            }
            
            // 检查是否包含常见弱密码
            const weakPasswords = ['password', '12345678', 'qwertyui', 'admin1234'];
            if (weakPasswords.includes(password.toLowerCase())) {
                return "密码过于简单，请选择更复杂的密码";
            }
            
            return null;
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        // 添加全局鼠标柔和光效
        document.body.addEventListener('mousemove', (e) => {
            const x = e.clientX;
            const y = e.clientY;
            
            document.body.style.setProperty('--mouse-x', `${x}px`);
            document.body.style.setProperty('--mouse-y', `${y}px`);
        });
        
        // 初始化鼠标位置在中心
        document.body.style.setProperty('--mouse-x', '50%');
        document.body.style.setProperty('--mouse-y', '50%');
    </script>
</body>
</html>